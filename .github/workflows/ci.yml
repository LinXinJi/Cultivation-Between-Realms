name: ci

on:
  push:
    branches:
      - master
      - main
    # 仅当文档/配置相关文件变化时触发，减少无效执行
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/ci.yml'
      - '.github/workflows/static.yml'

# 最小权限原则（原权限过宽，仅保留必要权限）
permissions:
  contents: write  # gh-deploy 需要写入内容权限
  issues: read     # 原配置写权限无必要，降级为读
  repository-projects: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 超时终止，避免卡死
    steps:
      # 1. 检出代码（升级版本+精简拉取）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 仅拉取最新提交，提速
          persist-credentials: true  # 保留凭证用于gh-deploy

      # 2. 配置Python（升级版本+缓存依赖）
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # 指定具体版本，避免3.x的不确定性
          cache: 'pip'  # 自动缓存pip依赖，无需重复安装

      # 3. 安装依赖（优化安装命令）
      - name: Install dependencies
        run: |
          echo "::group::Install mkdocs-material"
          pip install --upgrade pip  # 升级pip避免兼容问题
          pip install mkdocs-material --no-cache-dir  # 禁用本地缓存，减少冗余
          echo "::endgroup::"

      # 4. 部署文档（添加错误处理）
      - name: Deploy MkDocs to GitHub Pages
        run: mkdocs gh-deploy --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 显式传入token，避免环境问题
        continue-on-error: false  # 部署失败直接终止

      # 5. 触发static.yml（优化参数+容错）
      - name: Trigger static.yml workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: trigger-static-workflow
          repository: ${{ github.repository }}
          client-payload: |
            {
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}"  # 补充提交哈希，便于static.yml定位版本
            }
        # 仅当部署成功后触发，且失败时输出友好提示
        if: success()
        continue-on-error: true
        id: trigger-static
      
      # 6. 输出触发结果（便于调试）
      - name: Log trigger result
        run: |
          if [ "${{ steps.trigger-static.outcome }}" = "success" ]; then
            echo "✅ static.yml 触发成功"
          else
            echo "⚠️ static.yml 触发失败，请检查repository-dispatch权限"
          fi